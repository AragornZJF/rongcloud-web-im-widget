function QiniuJsSDK(){var a;a="https:"===window.location.protocol?"https://up.qbox.me":"http://upload.qiniu.com",this.detectIEVersion=function(){for(var a=4,b=document.createElement("div"),c=b.getElementsByTagName("i");b.innerHTML="<!--[if gt IE "+a+"]><i></i><![endif]-->",c[0];)a++;return a>4?a:!1},this.isImage=function(a){var b,c="",d=["png","jpg","jpeg","gif","bmp"],e=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!a||!e.test(a))return!1;b=e.exec(a),c=b[1].toLowerCase();for(var f=0,g=d.length;g>f;f++)if(c===d[f])return!0;return!1},this.getFileExtension=function(a){var b,c=a.split(".");return b=1===c.length||""===c[0]&&2===c.length?"":c.pop().toLowerCase()},this.utf8_encode=function(a){if(null===a||"undefined"==typeof a)return"";var b,c,d=a+"",e="",f=0;b=c=0,f=d.length;for(var g=0;f>g;g++){var h=d.charCodeAt(g),i=null;if(128>h)c++;else if(h>127&&2048>h)i=String.fromCharCode(h>>6|192,63&h|128);else if(63488&h^!0)i=String.fromCharCode(h>>12|224,h>>6&63|128,63&h|128);else{if(64512&h^!0)throw new RangeError("Unmatched trail surrogate at "+g);var j=d.charCodeAt(++g);if(64512&j^!0)throw new RangeError("Unmatched lead surrogate at "+(g-1));h=((1023&h)<<10)+(1023&j)+65536,i=String.fromCharCode(h>>18|240,h>>12&63|128,h>>6&63|128,63&h|128)}null!==i&&(c>b&&(e+=d.slice(b,c)),e+=i,b=c=g+1)}return c>b&&(e+=d.slice(b,f)),e},this.base64_encode=function(a){var b,c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=0,l=0,m="",n=[];if(!a)return a;a=this.utf8_encode(a+"");do b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),i=b<<16|c<<8|d,e=i>>18&63,f=i>>12&63,g=i>>6&63,h=63&i,n[l++]=j.charAt(e)+j.charAt(f)+j.charAt(g)+j.charAt(h);while(k<a.length);switch(m=n.join(""),a.length%3){case 1:m=m.slice(0,-2)+"==";break;case 2:m=m.slice(0,-1)+"="}return m},this.URLSafeBase64Encode=function(a){return a=this.base64_encode(a),a.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(a){var b={};return b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(a){return window.JSON&&window.JSON.parse?window.JSON.parse(a):null===a?a:"string"==typeof a&&(a=this.trim(a),a&&/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return a}():void 0},this.trim=function(a){return null===a?"":a.replace(/^\s+|\s+$/g,"")};var b=this;this.uploader=function(c){if(!c.domain)throw"uptoken_url or domain is required!";if(!c.browse_button)throw"browse_button is required!";var d={},e=c.init&&c.init.Error,f=c.init&&c.init.FileUploaded;c.init.Error=function(){},c.init.FileUploaded=function(){},b.uptoken_url=c.uptoken_url,b.token="",b.key_handler="function"==typeof c.init.Key?c.init.Key:"",this.domain=c.domain;var g="",h={isResumeUpload:!1,resumeFilesize:0,startTime:"",currentTime:""},i=function(){var a,d,e,f=b.detectIEVersion(),g="Safari"===mOxie.Env.browser&&mOxie.Env.version<=5&&"Windows"===mOxie.Env.os&&"7"===mOxie.Env.osVersion||"Safari"===mOxie.Env.browser&&"iOS"===mOxie.Env.os&&"7"===mOxie.Env.osVersion;f&&9>=f&&c.chunk_size&&c.runtimes.indexOf("flash")>=0?c.chunk_size=0:g?c.chunk_size=0:(a=20,d=4<<a,e=plupload.parseSize(c.chunk_size),e>d&&(c.chunk_size=d))};i();var j=function(){if(c.uptoken)b.token=c.uptoken;else{var a=b.createAjax();a.open("GET",b.uptoken_url,!0),a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){var c=b.parseJSON(a.responseText);b.token=c.uptoken}},a.send()}},k=function(a,d,e){var f="",g=!1;if(!c.save_key)if(g=a.getOption&&a.getOption("unique_names"),g=g||a.settings&&a.settings.unique_names){var h=b.getFileExtension(d.name);f=h?d.id+"."+h:d.id}else f="function"==typeof e?e(a,d):d.name;return f};plupload.extend(d,c,{url:a,multipart_params:{token:""}});var l=new plupload.Uploader(d);return l.bind("Init",function(a,b){j()}),l.init(),l.bind("FilesAdded",function(a,b){var c=a.getOption&&a.getOption("auto_start");c=c||a.settings&&a.settings.auto_start,c&&plupload.each(b,function(b,c){a.start()}),a.refresh()}),l.bind("BeforeUpload",function(d,e){e.speed=e.speed||0,g="",c.get_new_uptoken&&j();var f=function(d,e,f){h.startTime=(new Date).getTime();var g;g=c.save_key?{token:b.token}:{key:k(d,e,f),token:b.token};var i=c.x_vars;if(void 0!==i&&"object"==typeof i)for(var j in i)i.hasOwnProperty(j)&&("function"==typeof i[j]?g["x:"+j]=i[j](d,e):"object"!=typeof i[j]&&(g["x:"+j]=i[j]));d.setOption({url:a,multipart:!0,chunk_size:void 0,multipart_params:g})},i=d.getOption&&d.getOption("chunk_size");if(i=i||d.settings&&d.settings.chunk_size,"html5"===l.runtime&&i)if(e.size<i)f(d,e,b.key_handler);else{var m=localStorage.getItem(e.name),n=i;if(m){m=JSON.parse(m);var o=(new Date).getTime(),p=m.time||0,q=864e5;q>o-p&&100!==m.percent&&e.size===m.total?(e.percent=m.percent,e.loaded=m.offset,g=m.ctx,h.isResumeUpload=!0,h.resumeFilesize=m.offset,m.offset+n>e.size&&(n=e.size-m.offset)):localStorage.removeItem(e.name)}h.startTime=(new Date).getTime(),d.setOption({url:a+"/mkblk/"+n,multipart:!1,chunk_size:i,required_features:"chunks",headers:{Authorization:"UpToken "+b.token},multipart_params:{}})}else f(d,e,b.key_handler)}),l.bind("UploadProgress",function(a,b){h.currentTime=(new Date).getTime();var c=h.currentTime-h.startTime,d=b.loaded||0;h.isResumeUpload&&(d=b.loaded-h.resumeFilesize),b.speed=(d/c*1e3).toFixed(0)||0}),l.bind("ChunkUploaded",function(c,d,e){var f=b.parseJSON(e.response);g=g?g+","+f.ctx:f.ctx;var h=e.total-e.offset,i=c.getOption&&c.getOption("chunk_size");i=i||c.settings&&c.settings.chunk_size,i>h&&c.setOption({url:a+"/mkblk/"+h}),localStorage.setItem(d.name,JSON.stringify({ctx:g,percent:d.percent,total:e.total,offset:e.offset,time:(new Date).getTime()}))}),l.bind("Error",function(a){return function(c,d){var e="",f=d.file;if(f){switch(d.code){case plupload.FAILED:e="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var g=c.getOption&&c.getOption("max_file_size");g=g||c.settings&&c.settings.max_file_size,e="浏览器最大可上传"+g+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:e="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(""===d.response){e=d.message||"未知网络错误。";break}var h=b.parseJSON(d.response),i=h.error;switch(d.status){case 400:e="请求报文格式错误。";break;case 401:e="客户端认证授权失败。请重试或提交反馈。";break;case 405:e="客户端请求错误。请重试或提交反馈。";break;case 579:e="资源上传成功，但回调失败。";break;case 599:e="网络连接异常。请重试或提交反馈。";break;case 614:e="文件已存在。";try{h=b.parseJSON(h.error),i=h.error||"file exists"}catch(j){i=h.error||"file exists"}break;case 631:e="指定空间不存在。";break;case 701:e="上传数据块校验出错。请重试或提交反馈。";break;default:e="未知错误。"}e=e+"("+d.status+"："+i+")";break;case plupload.SECURITY_ERROR:e="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:e="上传失败。请稍后再试。";break;case plupload.IO_ERROR:e="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:e="网站配置错误。请联系网站管理员。",l.destroy();break;default:e=d.message+d.details}a&&a(c,d,e)}c.refresh()}}(e)),l.bind("FileUploaded",function(d){return function(e,f,h){var i=function(a,e,f){if(c.downtoken_url){var g=b.createAjax();g.open("POST",c.downtoken_url,!0),g.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g.onreadystatechange=function(){if(4===g.readyState)if(200===g.status){var c;try{c=b.parseJSON(g.responseText)}catch(h){throw"invalid json format"}var i={};plupload.extend(i,b.parseJSON(f),c),d&&d(a,e,JSON.stringify(i))}else l.trigger("Error",{status:g.status,response:g.responseText,file:e,code:plupload.HTTP_ERROR})},g.send("key="+b.parseJSON(f).key+"&domain="+c.domain)}else d&&d(a,e,f)};h.response=h.response.replace(/'/g,'"');var j=b.parseJSON(h.response);if(g=g?g:j.ctx){var m="";c.save_key||(m=k(e,f,b.key_handler),m=m?"/key/"+b.URLSafeBase64Encode(m):"");var n="/fname/"+b.URLSafeBase64Encode(f.name),o=c.x_vars,p="",q="";if(void 0!==o&&"object"==typeof o)for(var r in o)o.hasOwnProperty(r)&&("function"==typeof o[r]?p=b.URLSafeBase64Encode(o[r](e,f)):"object"!=typeof o[r]&&(p=b.URLSafeBase64Encode(o[r])),q+="/x:"+r+"/"+p);var s=a+"/mkfile/"+f.size+m+n+q,t=b.createAjax();t.open("POST",s,!0),t.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),t.setRequestHeader("Authorization","UpToken "+b.token),t.onreadystatechange=function(){if(4===t.readyState)if(localStorage.removeItem(f.name),200===t.status){var a=t.responseText;i(e,f,a)}else l.trigger("Error",{status:t.status,response:t.responseText,file:f,code:-200})},t.send(g)}else i(e,f,h.response)}}(f)),l},this.getUrl=function(a){if(!a)return!1;a=encodeURI(a);var b=this.domain;return"/"!==b.slice(b.length-1)&&(b+="/"),b+a},this.imageView2=function(a,b){var c=a.mode||"",d=a.w||"",e=a.h||"",f=a.q||"",g=a.format||"";if(!c)return!1;if(!d&&!e)return!1;var h="imageView2/"+c;return h+=d?"/w/"+d:"",h+=e?"/h/"+e:"",h+=f?"/q/"+f:"",h+=g?"/format/"+g:"",b&&(h=this.getUrl(b)+"?"+h),h},this.imageMogr2=function(a,b){var c=a["auto-orient"]||"",d=a.thumbnail||"",e=a.strip||"",f=a.gravity||"",g=a.crop||"",h=a.quality||"",i=a.rotate||"",j=a.format||"",k=a.blur||"",l="imageMogr2";return l+=c?"/auto-orient":"",l+=d?"/thumbnail/"+d:"",l+=e?"/strip":"",l+=f?"/gravity/"+f:"",l+=h?"/quality/"+h:"",l+=g?"/crop/"+g:"",l+=i?"/rotate/"+i:"",l+=j?"/format/"+j:"",l+=k?"/blur/"+k:"",b&&(l=this.getUrl(b)+"?"+l),l},this.watermark=function(a,b){var c=a.mode;if(!c)return!1;var d="watermark/"+c;if(1===c){var e=a.image||"";if(!e)return!1;d+=e?"/image/"+this.URLSafeBase64Encode(e):""}else{if(2!==c)return!1;var f=a.text?a.text:"",g=a.font?a.font:"",h=a.fontsize?a.fontsize:"",i=a.fill?a.fill:"";if(!f)return!1;d+=f?"/text/"+this.URLSafeBase64Encode(f):"",d+=g?"/font/"+this.URLSafeBase64Encode(g):"",d+=h?"/fontsize/"+h:"",d+=i?"/fill/"+this.URLSafeBase64Encode(i):""}var j=a.dissolve||"",k=a.gravity||"",l=a.dx||"",m=a.dy||"";return d+=j?"/dissolve/"+j:"",d+=k?"/gravity/"+k:"",d+=l?"/dx/"+l:"",d+=m?"/dy/"+m:"",b&&(d=this.getUrl(b)+"?"+d),d},this.imageInfo=function(a){if(!a)return!1;var b,c=this.getUrl(a)+"?imageInfo",d=this.createAjax(),e=this;return d.open("GET",c,!1),d.onreadystatechange=function(){4===d.readyState&&200===d.status&&(b=e.parseJSON(d.responseText))},d.send(),b},this.exif=function(a){if(!a)return!1;var b,c=this.getUrl(a)+"?exif",d=this.createAjax(),e=this;return d.open("GET",c,!1),d.onreadystatechange=function(){4===d.readyState&&200===d.status&&(b=e.parseJSON(d.responseText))},d.send(),b},this.get=function(a,b){return b&&a?"exif"===a?this.exif(b):"imageInfo"===a?this.imageInfo(b):!1:!1},this.pipeline=function(a,b){var c,d,e="[object Array]"===Object.prototype.toString.call(a),f="";if(e){for(var g=0,h=a.length;h>g;g++){if(c=a[g],!c.fop)return!1;switch(c.fop){case"watermark":f+=this.watermark(c)+"|";break;case"imageView2":f+=this.imageView2(c)+"|";break;case"imageMogr2":f+=this.imageMogr2(c)+"|";break;default:d=!0}if(d)return!1}if(b){f=this.getUrl(b)+"?"+f;var i=f.length;"|"===f.slice(i-1)&&(f=f.slice(0,i-1))}return f}return!1}}!function(a){a&&(a.rebox=function(b,c){this.settings=a.extend(!0,{},a.rebox.defaults,c),this.$el=b,this.$box=null,this.$items=null,this.idx=0,this.enable()},a.rebox.defaults={theme:"rebox",selector:null,prev:"&larr;",next:"&rarr;",loading:"%",close:"&times;",speed:400,zIndex:1e3,cycle:!0,captionAttr:"title",template:"image",templates:{image:function(b,c,d){return a('<img src="'+b.attr("href")+'" class="'+c.theme+'-content" />').load(d)}}},a.rebox.setDefaults=function(b){a.rebox.defaults=a.extend(!0,{},a.rebox.defaults,b)},a.rebox.lookup={i:0},a.extend(a.rebox.prototype,{enable:function(){var a=this;return a.$el.on("click.rebox",a.settings.selector,function(b){b.preventDefault(),a.open(this)})},open:function(b){var c=this;return c.$items=null===c.settings.selector?c.$el:c.$el.find(c.settings.selector),isNaN(b)&&(b=c.$items.index(b)),c.$box=a('<div class="'+c.settings.theme+'" style="display:none;"><a href="#" class="'+c.settings.theme+"-close "+c.settings.theme+'-button">'+c.settings.close+'</a><a href="#" class="'+c.settings.theme+"-prev "+c.settings.theme+'-button">'+c.settings.prev+'</a><a href="#" class="'+c.settings.theme+"-next "+c.settings.theme+'-button">'+c.settings.next+'</a><div class="'+c.settings.theme+'-contents"></div><div class="'+c.settings.theme+'-caption"><p></p></div></div>').appendTo("body").css("zIndex",c.settings.zIndex).fadeIn(c.settings.speed).on("click.rebox","."+c.settings.theme+"-close",function(a){a.preventDefault(),c.close()}).on("click.rebox","."+c.settings.theme+"-next",function(a){a.preventDefault(),c.next()}).on("click.rebox","."+c.settings.theme+"-prev",function(a){a.preventDefault(),c.prev()}),a(document).on("swipeLeft.rebox",function(a){c.next()}).on("swipeRight.rebox",function(a){c.prev()}).on("keydown.rebox",function(a){a.preventDefault();var b=window.event?event.keyCode:a.keyCode;switch(b){case 27:c.close();break;case 37:c.prev();break;case 39:c.next()}}),c.$el.trigger("rebox:open",[c]),c["goto"](b),c.$el},close:function(){var b=this;return b.$box&&b.$box.length&&b.$box.fadeOut(b.settings.speed,function(a){b.$box.remove(),b.$box=null,b.$el.trigger("rebox:close",[b])}),a(document).off(".rebox"),b.$el},"goto":function(b){var c=this,d=a(c.$items[b]),e=d.attr(c.settings.captionAttr),f=(c.$box.children("."+c.settings.theme+"-caption")[e?"show":"hide"]().children("p").text(e),c.$box.children("."+c.settings.theme+"-contents")),g=null;return d.length&&(c.idx=b,f.html('<div class="'+c.settings.theme+"-loading "+c.settings.theme+'-button">'+c.settings.loading+"</div>"),g=c.settings.templates[d.data("rebox-template")||c.settings.template](d,c.settings,function(b){f.empty().append(a(this))}),1!=c.$items.length&&c.settings.cycle||(c.$box.children("."+c.settings.theme+"-prev")[0>=b?"hide":"show"](),c.$box.children("."+c.settings.theme+"-next")[b>=c.$items.length-1?"hide":"show"]()),c.$el.trigger("rebox:goto",[c,b,d,g])),c.$el},prev:function(){var a=this;return a["goto"](0===a.idx?a.$items.length-1:a.idx-1)},next:function(){var a=this;return a["goto"](a.idx===a.$items.length-1?0:a.idx+1)},disable:function(){var a=this;return a.close().off(".rebox").trigger("rebox:disable",[a])},destroy:function(){var a=this;return a.disable().removeData("rebox").trigger("rebox:destroy")},option:function(a,b){var c=this;return void 0!==b?(c.settings[a]=b,c.disable().enable()):c.settings[a]}}),a.fn.rebox=function(b){b=b||{};var c=Array.prototype.slice.call(arguments);if("string"==typeof b){if("option"==b&&"string"==typeof c[1]&&2===c.length){var d=a.rebox.lookup[a(this).data("rebox")];return d[b].apply(d,c.slice(1))}return this.each(function(){var d=a.rebox.lookup[a(this).data("rebox")];d[b].apply(d,c.slice(1))})}return this.each(function(){var c=a(this);a.rebox.lookup[++a.rebox.lookup.i]=new a.rebox(c,b),c.data("rebox",a.rebox.lookup.i)})})}(window.jQuery||window.Zepto||window.$);var conversationController=angular.module("RongWebIMWidget.conversationController",["RongWebIMWidget.conversationServer"]);conversationController.controller("conversationController",["$scope","conversationServer","WebIMWidget","conversationListServer","widgetConfig","providerdata",function(a,b,c,d,e,f){function g(){setTimeout(function(){var a=document.getElementById("Messages");a&&(a.scrollTop=a.scrollHeight)},0)}function h(){RongIMLib.RongIMClient.getInstance().getFileToken(RongIMLib.FileType.IMAGE,{onSuccess:function(a){b._uploadToken=a.token,m()},onError:function(){}})}function i(a){return a.conversationType==WidgetModule.EnumConversationType.CUSTOMER_SERVICE&&a.content&&a.messageDirection==WidgetModule.MessageDirection.RECEIVE?"1"==b._customService.currentType?a.content.userInfo={name:b._customService.human.name||"客服人员",portraitUri:b._customService.human.headimgurl||b._customService.robotIcon}:a.content.userInfo={name:b._customService.robotName,portraitUri:b._customService.robotIcon}:a.conversationType==WidgetModule.EnumConversationType.CUSTOMER_SERVICE&&a.content&&a.messageDirection==WidgetModule.MessageDirection.SEND&&(a.content.userInfo={name:"我",portraitUri:b.loginUser.portraitUri}),a}function j(c,d){var e=new RongIMLib.Message,f=new RongIMLib.UserInfo(b.loginUser.id,b.loginUser.name||"我",b.loginUser.portraitUri);return c.user=f,e.content=c,e.conversationType=a.currentConversation.targetType,e.targetId=a.currentConversation.targetId,e.senderUserId=b.loginUser.id,e.messageDirection=RongIMLib.MessageDirection.SEND,e.sentTime=(new Date).getTime()-(RongIMLib.RongIMClient.getInstance().getDeltaTime()||0),e.messageType=d,e}function k(b,c){var d=new RongIMLib.Message,e=null;return b.userInfo=e,d.content=b,d.conversationType=a.currentConversation.targetType,d.targetId=a.currentConversation.targetId,d.senderUserId=a.currentConversation.targetId,d.messageDirection=RongIMLib.MessageDirection.RECEIVE,d.sentTime=(new Date).getTime()-(RongIMLib.RongIMClient.getInstance().getDeltaTime()||0),d.messageType=c,d}function l(){c.onClose&&"function"==typeof c.onClose&&c.onClose(a.currentConversation),e.displayConversationList?a.showSelf=!1:a.WebIMWidget.display=!1,a.messageList=[],a.currentConversation=null,b.current=null}function m(){p&&p.destroy(),p=Qiniu.uploader({runtimes:"html5,html4",browse_button:"upload-file",container:"funcPanel",drop_element:"inputMsg",max_file_size:"100mb",dragdrop:!0,chunk_size:"4mb",uptoken:b._uploadToken,domain:n,get_new_uptoken:!1,filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png,jpeg,bmp"}],prevent_duplicates:!1},multi_selection:!1,auto_start:!0,init:{FilesAdded:function(a,b){},BeforeUpload:function(a,b){},UploadProgress:function(a,b){},UploadComplete:function(){},FileUploaded:function(c,e,f){return a.currentConversation.targetId&&a.currentConversation.targetType?(f=f.replace(/'/g,'"'),f=JSON.parse(f),void RongIMLib.RongIMClient.getInstance().getFileUrl(RongIMLib.FileType.IMAGE,f.name,{onSuccess:function(c){WidgetModule.Helper.ImageHelper.getThumbnail(e.getNative(),6e4,function(e,f){var i=RongIMLib.ImageMessage.obtain(f,c.downloadUrl),k=j(i,WidgetModule.MessageType.ImageMessage);RongIMLib.RongIMClient.getInstance().sendMessage(a.currentConversation.targetType,a.currentConversation.targetId,i,{onSuccess:function(){d.updateConversations().then(function(){})},onError:function(){}}),b._addHistoryMessages(WidgetModule.Message.convert(k)),a.$apply(),g(),h()})},onError:function(){}})):void alert("请先选择一个会话目标。")},Error:function(a,b,c){console.log(b),h()}}})}var n="http://7xogjk.com1.z0.glb.clouddn.com/";a.currentConversation={title:"",targetId:"",targetType:0},a.messageList=[],a.messageContent="",a.WebIMWidget=c,a.widgetConfig=e,console.log(e),a.conversationServer=b,a._inputPanelState=WidgetModule.InputPanelType.person,a.showSelf=!1,a.showemoji=!1,document.addEventListener("click",function(b){a.showemoji&&-1==b.target.className.indexOf("iconfont-smile")&&a.$apply(function(){a.showemoji=!1})}),a.$watch("showemoji",function(b,c){b!==c&&(a.emojiList&&0!=a.emojiList.length||(a.emojiList=RongIMLib.RongIMEmoji.emojis.slice(0,84)))}),a.$watch("currentConversation.messageContent",function(b,c){b!==c&&a.currentConversation&&RongIMLib.RongIMClient.getInstance().saveTextMessageDraft(+a.currentConversation.targetType,a.currentConversation.targetId,b)}),a.$watch("showSelf",function(a,c){a!==c&&(a&&b._uploadToken?(m(),console.log("showSelf")):p&&p.destroy())}),a.$watch("_inputPanelState",function(a,c){a!==c&&(a==WidgetModule.InputPanelType.person&&b._uploadToken?(m(),console.log("_inputPanelState")):p&&p.destroy())}),b.onConversationChangged=function(c){if(setTimeout(function(){a.$apply()},0),e.displayConversationList?a.showSelf=!0:(a.showSelf=!0,a.WebIMWidget.display=!0),!c||c.targetType!=WidgetModule.EnumConversationType.CUSTOMER_SERVICE||b.current&&b.current.targetId==c.targetId||RongIMLib.RongIMClient.getInstance().startCustomService(c.targetId,{onSuccess:function(){},onError:function(){console.log("连接客服失败")}}),!c||!c.targetId)return a.messageList=[],a.currentConversation=null,b.current=null,void setTimeout(function(){a.$apply()});b.current=c,a.currentConversation=c,b._cacheHistory[c.targetType+"_"+c.targetId]=b._cacheHistory[c.targetType+"_"+c.targetId]||[];var d=b._cacheHistory[c.targetType+"_"+c.targetId]||[];a.messageList=d,0==d.length?b._getHistoryMessages(+c.targetType,c.targetId,3).then(function(d){a.messageList=b._cacheHistory[c.targetType+"_"+c.targetId],a.messageList.length>0&&(a.messageList.unshift(new WidgetModule.TimePanl(a.messageList[0].sentTime)),d.has&&a.messageList.unshift(new WidgetModule.GetMoreMessagePanel),g())}):g(),a.currentConversation.messageContent=RongIMLib.RongIMClient.getInstance().getTextMessageDraft(+a.currentConversation.targetType,a.currentConversation.targetId)||"",setTimeout(function(){a.$apply()})},b.onReceivedMessage=function(c){if(a.currentConversation&&c.targetId==a.currentConversation.targetId&&c.conversationType==a.currentConversation.targetType){a.$apply();var d=null;switch(c.messageType){case WidgetModule.MessageType.HandShakeResponseMessage:b._customService.type=c.content.data.serviceType,b._customService.companyName=c.content.data.companyName,b._customService.robotName=c.content.data.robotName,b._customService.robotIcon=c.content.data.robotIcon,b._customService.robotWelcome=c.content.data.robotWelcome,b._customService.humanWelcome=c.content.data.humanWelcome,b._customService.noOneOnlineTip=c.content.data.noOneOnlineTip,"1"==c.content.data.serviceType?(o(WidgetModule.InputPanelType.robot),c.content.data.robotWelcome&&(d=k(RongIMLib.TextMessage.obtain(c.content.data.robotWelcome),WidgetModule.MessageType.TextMessage))):"3"==c.content.data.serviceType?(c.content.data.robotWelcome&&(d=k(RongIMLib.TextMessage.obtain(c.content.data.robotWelcome),WidgetModule.MessageType.TextMessage)),o(WidgetModule.InputPanelType.robotSwitchPerson)):o(WidgetModule.InputPanelType.person),a.evaluate.valid=!1,setTimeout(function(){a.evaluate.valid=!0},6e4);break;case WidgetModule.MessageType.ChangeModeResponseMessage:switch(c.content.data.status){case 1:b._customService.human.name=c.content.data.name||"客服人员",b._customService.human.headimgurl=c.content.data.headimgurl,o(WidgetModule.InputPanelType.person);break;case 2:"2"==b._customService.type?o(WidgetModule.InputPanelType.person):"1"!=b._customService.type&&"3"!=b._customService.type||o(WidgetModule.InputPanelType.robotSwitchPerson);break;case 3:o(WidgetModule.InputPanelType.robot),d=k(RongIMLib.InformationNotificationMessage.obtain("你被拉黑了"),WidgetModule.MessageType.InformationNotificationMessage);break;case 4:o(WidgetModule.InputPanelType.person),d=k(RongIMLib.InformationNotificationMessage.obtain("已经是人工了"),WidgetModule.MessageType.InformationNotificationMessage)}break;case WidgetModule.MessageType.TerminateMessage:0==c.content.code?(a.evaluate.CSTerminate=!0,a.close()):o("1"==b._customService.type?WidgetModule.InputPanelType.robot:WidgetModule.InputPanelType.robotSwitchPerson);break;case WidgetModule.MessageType.CustomerStatusUpdateMessage:switch(Number(c.content.serviceStatus)){case 1:o("1"==b._customService.type?WidgetModule.InputPanelType.robot:WidgetModule.InputPanelType.robotSwitchPerson);break;case 2:o(WidgetModule.InputPanelType.person);break;case 3:o(WidgetModule.InputPanelType.notService)}}if(d){var e=WidgetModule.Message.convert(d);i(e),b._addHistoryMessages(e)}i(c),setTimeout(function(){g()},200)}},b._onConnectSuccess=function(){h()},a.getHistory=function(){var c=b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId];c.splice(0,c.length),b._getHistoryMessages(+a.currentConversation.targetType,a.currentConversation.targetId,20).then(function(c){a.messageList=b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId],c.has&&b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId].unshift(new WidgetModule.GetMoreMessagePanel)})},a.getMoreMessage=function(){b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId].shift(),b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId].shift(),b._getHistoryMessages(+a.currentConversation.targetType,a.currentConversation.targetId,20).then(function(c){a.messageList=b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId],c.has&&b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId].unshift(new WidgetModule.GetMoreMessagePanel)})};var o=function(c){a._inputPanelState=c,c==WidgetModule.InputPanelType.person?(a.evaluate.type=1,b._customService.currentType="1",b.current.title=b._customService.human.name||"客服人员"):(a.evaluate.type=2,b._customService.currentType="2",b.current.title=b._customService.robotName)};a.evaluate={type:1,showevaluate:!1,valid:!1,CSTerminate:!1,onConfirm:function(c){c&&(1==a.value?RongIMLib.RongIMClient.getInstance().evaluateHumanCustomService(b.current.targetId,c.stars,c.describe,{onSuccess:function(){}}):RongIMLib.RongIMClient.getInstance().evaluateRebotCustomService(b.current.targetId,c.value,c.describe,{onSuccess:function(){}})),RongIMLib.RongIMClient.getInstance().stopCustomeService(b.current.targetId,{onSuccess:function(){},onError:function(){}}),l()},onCancle:function(){RongIMLib.RongIMClient.getInstance().stopCustomeService(b.current.targetId,{onSuccess:function(){},onError:function(){}}),l()}},a.close=function(){if(c.onCloseBefore&&"function"==typeof c.onCloseBefore){c.onCloseBefore({close:function(c){b.current.targetType==WidgetModule.EnumConversationType.CUSTOMER_SERVICE?a.evaluate.valid?a.evaluate.showevaluate=!0:a.evaluate.onCancle():l()}})}else b.current.targetType==WidgetModule.EnumConversationType.CUSTOMER_SERVICE?a.evaluate.valid?a.evaluate.showevaluate=!0:a.evaluate.onCancle():l()},a.send=function(){if(!a.currentConversation.targetId||!a.currentConversation.targetType)return void alert("请先选择一个会话目标。");if(""!=a.currentConversation.messageContent){var c=RongIMLib.RongIMEmoji.symbolToEmoji(a.currentConversation.messageContent),e=RongIMLib.TextMessage.obtain(c),f=new RongIMLib.UserInfo(b.loginUser.id,b.loginUser.name,b.loginUser.portraitUri);e.user=f;try{RongIMLib.RongIMClient.getInstance().sendMessage(+a.currentConversation.targetType,a.currentConversation.targetId,e,{onSuccess:function(a){d.updateConversations().then(function(){})},onError:function(a){console.log(a)}})}catch(h){console.log(h)}var i=j(e,WidgetModule.MessageType.TextMessage),k=WidgetModule.Message.convert(i);b._addHistoryMessages(k),g(),a.currentConversation.messageContent="";var l=document.getElementById("inputMsg");WidgetModule.Helper.getFocus(l)}},a.minimize=function(){c.display=!1},a.switchPerson=function(){RongIMLib.RongIMClient.getInstance().switchToHumanMode(b.current.targetId,{onSuccess:function(){},onError:function(){}})};var p}]);var conversationDirective=angular.module("RongWebIMWidget.conversationDirective",["RongWebIMWidget.conversationController"]);conversationDirective.directive("rongConversation",[function(){return{restrict:"E",templateUrl:"./src/ts/conversation/template.tpl.html",controller:"conversationController",link:function(a,b){window.jQuery&&window.jQuery.nicescroll&&$("#Messages").niceScroll({cursorcolor:"#0099ff",cursoropacitymax:1,touchbehavior:!1,cursorwidth:"8px",cursorborder:"0",cursorborderradius:"5px"})}}}]),conversationDirective.directive("emoji",[function(){return{restrict:"E",scope:{item:"=",content:"="},template:'<div style="display:inline-block"></div>',link:function(a,b,c){b.find("div").append(a.item),b.on("click",function(){a.$parent.currentConversation.messageContent=a.$parent.currentConversation.messageContent||"",a.$parent.currentConversation.messageContent=a.$parent.currentConversation.messageContent.replace(/\n$/,""),a.$parent.currentConversation.messageContent=a.$parent.currentConversation.messageContent+a.item.children[0].getAttribute("name"),a.$parent.$apply();var b=document.getElementById("inputMsg");WidgetModule.Helper.getFocus(b)})}}}]),conversationDirective.directive("contenteditableDire",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){function e(a){return a.replace(new RegExp("<[\\s\\S.]*?>","ig"),"")}function f(){var a=b.html();a=a.replace(/^<br>$/i,""),a=a.replace(/<br>/gi,"\n"),c.stripBr&&"<br>"==a&&(a=""),d.$setViewValue(a)}var g=b[0];a.$watch(function(){return d.$modelValue},function(a){document.activeElement!==g&&(""!==a&&a!==c.placeholder||(g.innerHTML=c.placeholder,g.style.color="#a9a9a9"))}),b.bind("focus",function(){g.innerHTML==c.placeholder&&(g.innerHTML=""),g.style.color=""}),b.bind("blur",function(){""===g.innerHTML&&(g.innerHTML=c.placeholder,g.style.color="#a9a9a9")}),d&&(b.bind("paste",function(a){var b=this;b.innerHTML;c&&clearTimeout(c);var c=setTimeout(function(){b.innerHTML=e(b.innerHTML),d.$setViewValue(b.innerHTML),c=null},50)}),d.$render=function(){b.html(d.$viewValue||"")},b.bind("keyup paste",f))}}}),conversationDirective.directive("ctrlEnterKeys",["$timeout",function(a){return{restrict:"A",require:"?ngModel",scope:{fun:"&",ctrlenter:"=",content:"="},link:function(a,b,c,d){a.ctrlenter=a.ctrlenter||!1,b.bind("keypress",function(b){a.ctrlenter?(b.ctrlKey===!0&&13===b.keyCode||10===b.keyCode)&&(a.fun(),a.$parent.$apply(),b.preventDefault()):b.ctrlKey!==!1||b.shiftKey!==!1||13!==b.keyCode&&10!==b.keyCode?b.ctrlKey===!0&&13===b.keyCode||10===b.keyCode:(a.fun(),a.$parent.$apply(),b.preventDefault())})}}}]),conversationDirective.directive("textmessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-text"><pre class="rongcloud-Message-entry" ng-bind-html="msg.content|trustHtml"><br></pre></div></div>'}}]),conversationDirective.directive("includinglinkmessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-text"><pre class="rongcloud-Message-entry" style="">维护中 由于我们的服务商出现故障，融云官网及相关服务也受到影响，给各位用户带来的不便，还请谅解。  您可以通过 <a href="#">【官方微博】</a>了解</pre></div></div>'}}]),conversationDirective.directive("imagemessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-img"><span id="{{\'rebox_\'+$id}}"  class="rongcloud-Message-entry" style=""><a href="{{msg.imageUri}}" target="_black"><img ng-src="{{msg.content}}"  data-image="{{msg.imageUri}}" alt=""/></a></span></div></div>',link:function(a,b,c){var d=new Image;d.src=a.msg.imageUri,setTimeout(function(){window.jQuery&&window.jQuery.rebox&&$("#rebox_"+a.$id).rebox({selector:"a",zIndex:999999}).bind("rebox:open",function(){var a=document.getElementsByClassName("rebox")[0];a.onclick=function(b){if("img"!=b.target.tagName.toLowerCase()){var c=document.getElementsByClassName("rebox-close")[0];c.click(),a=null,c=null}}})}),d.onload=function(){a.$apply(function(){a.msg.content=a.msg.imageUri})},a.showBigImage=function(){}}}}]),conversationDirective.directive("voicemessage",["$timeout",function(a){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-audio"><span class="rongcloud-Message-entry" style=""><span class="rongcloud-audioBox rongcloud-clearfix " ng-click="play()" ng-class="{\'animate\':isplaying}" ><i></i><i></i><i></i></span><div style="display: inline-block;" ><span class="rongcloud-audioTimer">{{msg.duration}}”</span><span class="rongcloud-audioState" ng-show="msg.isUnReade"></span></div></span></div></div>',link:function(b,c,d){b.msg.duration=parseInt(b.msg.duration||b.msg.content.length/1024),RongIMLib.RongIMVoice.preLoaded(b.msg.content),b.play=function(){RongIMLib.RongIMVoice.stop(b.msg.content),b.isplaying?(b.isplaying=!1,a.cancel(b.timeoutid)):(b.msg.isUnReade=!1,RongIMLib.RongIMVoice.play(b.msg.content,b.msg.duration),b.isplaying=!0,b.timeoutid&&a.cancel(b.timeoutid),b.timeoutid=a(function(){b.isplaying=!1},1e3*b.msg.duration))}}}}]),conversationDirective.directive("locationmessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-map"><span class="rongcloud-Message-entry" style=""><div class="rongcloud-mapBox"><img ng-src="{{msg.content}}" alt=""><span>{{msg.poi}}</span></div></span></div></div>'}}]),conversationDirective.directive("richcontentmessage",[function(){
return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-image-text"><span class="rongcloud-Message-entry" style=""><div class="rongcloud-image-textBox"><h4>{{msg.title}}</h4><div class="rongcloud-cont rongcloud-clearfix"><img ng-src="{{msg.imageUri}}" alt=""><div>{{msg.content}}</div></div></div></span></div></div>'}}]);var conversationServer=angular.module("RongWebIMWidget.conversationServer",["RongWebIMWidget.conversationDirective"]);conversationServer.factory("conversationServer",["$q","providerdata",function(a,b){function c(a,b,c){var e=d._cacheHistory[b+"_"+a]=d._cacheHistory[b+"_"+a]||[];e[0]&&e[0].sentTime&&e[0].panelType!=WidgetModule.PanelType.Time&&c.sentTime&&(WidgetModule.Helper.timeCompare(e[0].sentTime,c.sentTime)||e.unshift(new WidgetModule.TimePanl(e[0].sentTime))),e.unshift(c)}var d={};return d.current={targetId:"",targetType:0,title:"",portraitUri:"",onLine:!1},d.loginUser={id:"",name:"",portraitUri:""},d._cacheHistory={},d._getHistoryMessages=function(d,e,f,g){var h=a.defer();return RongIMLib.RongIMClient.getInstance().getHistoryMessages(d,e,g?0:null,f,{onSuccess:function(a,f){for(var g=a.length;g--;){var i=WidgetModule.Message.convert(a[g]);c(e,d,i),i.content&&b.getUserInfo&&!function(a){b.getUserInfo(a.senderUserId,{onSuccess:function(b){a.content.userInfo=new WidgetModule.UserInfo(b.userId,b.name,b.portraitUri)}})}(i)}h.resolve({data:a,has:f})},onError:function(a){h.reject(a)}}),h.promise},d._addHistoryMessages=function(a){var b=d._cacheHistory[a.conversationType+"_"+a.targetId]=d._cacheHistory[a.conversationType+"_"+a.targetId]||[];b[b.length-1]&&b[b.length-1].panelType!=WidgetModule.PanelType.Time&&b[b.length-1].sentTime&&a.sentTime&&(WidgetModule.Helper.timeCompare(b[b.length-1].sentTime,a.sentTime)||b.push(new WidgetModule.TimePanl(a.sentTime))),b.push(a)},d.onConversationChangged=function(){},d.onReceivedMessage=function(){},d._customService={human:{}},d}]);var conversationListCtr=angular.module("RongWebIMWidget.conversationListController",[]);conversationListCtr.controller("conversationListController",["$scope","conversationListServer","WebIMWidget","widgetConfig","providerdata",function(a,b,c,d,e){function f(){var a=b.conversationList.map(function(a){return a.targetId});e.getOnlineStatus(a,{onSuccess:function(a){b._onlineStatus=a,b.updateConversations()}})}function g(){h=setInterval(function(){f()},1e4)}a.conversationListServer=b,a.WebIMWidget=c,b.refreshConversationList=function(){setTimeout(function(){a.$apply()})},a.minbtn=function(){c.display=!1};var h,i=WidgetModule.Helper.CookieHelper.getCookie("voiceSound");e.voiceSound=i?"true"==i:!0,a.data=e,a.config=d,a.$watch("data.voiceSound",function(a,b){a!==b&&WidgetModule.Helper.CookieHelper.setCookie("voiceSound",a)}),a.connected=!0,b._onConnectStatusChange=function(b){b==RongIMLib.ConnectionStatus.CONNECTED?(a.connected=!0,d.displayConversationList&&e.getOnlineStatus&&(f(),g())):a.connected=!1,setTimeout(function(){a.$apply()})}}]);var conversationListDir=angular.module("RongWebIMWidget.conversationListDirective",["RongWebIMWidget.conversationListController"]);conversationListDir.directive("rongConversationList",[function(){return{restrict:"E",templateUrl:"./src/ts/conversationlist/conversationList.tpl.html",controller:"conversationListController",link:function(a,b){window.jQuery&&window.jQuery.nicescroll&&$(b).find(".rongcloud-content").niceScroll({cursorcolor:"#0099ff",cursoropacitymax:1,touchbehavior:!1,cursorwidth:"8px",cursorborder:"0",cursorborderradius:"5px"})}}}]),conversationListDir.directive("conversationItem",["conversationServer","conversationListServer","RongIMSDKServer",function(a,b,c){return{restrict:"E",scope:{item:"="},template:'<div class="rongcloud-chatList"><div class="rongcloud-chat_item " ng-class="{\'online\':item.onLine}"><div class="rongcloud-ext"><p class="rongcloud-attr clearfix"><span class="rongcloud-badge" ng-show="item.unreadMessageCount>0">{{item.unreadMessageCount>99?"99+":item.unreadMessageCount}}</span><i class="rongcloud-sprite rongcloud-no-remind" ng-click="remove($event)"></i></p></div><div class="rongcloud-photo"><img class="rongcloud-img" ng-src="{{item.portraitUri}}" err-src="http://7xo1cb.com1.z0.glb.clouddn.com/20160230163460.jpg" alt=""><i ng-show="!!$parent.data.getOnlineStatus" class="rongcloud-Presence rongcloud-Presence--stacked rongcloud-Presence--mainBox"></i></div><div class="rongcloud-info"><h3 class="rongcloud-nickname"><span class="rongcloud-nickname_text" title="{{item.title}}">{{item.title}}</span></h3></div></div></div>',link:function(d,e,f){e.on("click",function(){a.onConversationChangged(new WidgetModule.Conversation(d.item.targetType,d.item.targetId,d.item.title)),d.item.unreadMessageCount>0&&(RongIMLib.RongIMClient.getInstance().clearUnreadCount(d.item.targetType,d.item.targetId,{onSuccess:function(){},onError:function(){}}),c.sendReadReceiptMessage(d.item.targetId,Number(d.item.targetType)),b.updateConversations())}),d.remove=function(c){c.stopPropagation(),RongIMLib.RongIMClient.getInstance().removeConversation(d.item.targetType,d.item.targetId,{onSuccess:function(){a.current.targetType==d.item.targetType&&a.current.targetId==d.item.targetId,b.updateConversations()},onError:function(a){console.log(a)}})}}}}]);var conversationListSer=angular.module("RongWebIMWidget.conversationListServer",["RongWebIMWidget.conversationListDirective","RongWebIMWidget"]);conversationListSer.factory("conversationListServer",["$q","providerdata","widgetConfig","RongIMSDKServer","conversationServer",function(a,b,c,d,e){var f={};return f.conversationList=[],f._onlineStatus=[],f.updateConversations=function(){var g=a.defer();return RongIMLib.RongIMClient.getInstance().getConversationList({onSuccess:function(a){f.conversationList.splice(0,f.conversationList.length);for(var h=0,i=a.length;i>h;h++){var j=WidgetModule.Conversation.onvert(a[h]);switch(j.targetType){case RongIMLib.ConversationType.PRIVATE:"function"==WidgetModule.Helper.checkType(b.getUserInfo)&&!function(a,c){b.getUserInfo(a.targetId,{onSuccess:function(b){a.title=b.name,a.portraitUri=b.portraitUri,c.conversationTitle=b.name,c.portraitUri=b.portraitUri}})}(j,a[h]);break;case RongIMLib.ConversationType.GROUP:"function"==WidgetModule.Helper.checkType(b.getGroupInfo)&&!function(a,c){b.getGroupInfo(a.targetId,{onSuccess:function(b){a.title=b.name,a.portraitUri=b.portraitUri,c.conversationTitle=b.name,c.portraitUri=b.portraitUri}})}(j,a[h]);break;case RongIMLib.ConversationType.CHATROOM:}f.conversationList.push(j)}f._onlineStatus.forEach(function(a){var b=f.getConversation(WidgetModule.EnumConversationType.PRIVATE,a.id);b&&(b.onLine=a.status)}),c.displayConversationList?RongIMLib.RongIMClient.getInstance().getTotalUnreadCount({onSuccess:function(a){b.totalUnreadCount=a||0,g.resolve(),f.refreshConversationList()},onError:function(){}}):d.getConversation(e.current.targetType,e.current.targetId).then(function(a){a&&a.unreadMessageCount?(b.totalUnreadCount=a.unreadMessageCount||0,g.resolve(),f.refreshConversationList()):(b.totalUnreadCount=0,g.resolve(),f.refreshConversationList())})},onError:function(a){g.reject(a)}},null),g.promise},f.refreshConversationList=function(){},f.getConversation=function(a,b){for(var c=0,d=f.conversationList.length;d>c;c++)if(f.conversationList[c].targetType==a&&f.conversationList[c].targetId==b)return f.conversationList[c];return null},f.addConversation=function(a){f.conversationList.unshift(a)},f._onConnectStatusChange=function(){},f}]);var evaluate=angular.module("Evaluate",[]);evaluate.directive("evaluatedir",["$timeout",function(a){return{restrict:"E",scope:{type:"=",display:"=",enter:"&confirm",dcancle:"&cancle"},templateUrl:"./src/ts/evaluate/evaluate.tpl.html",link:function(b,c){function d(c){b.end=!0,c?a(function(){b.display=!1,b.end=!1,b.enter({data:c})},800):(b.display=!1,b.end=!1,b.enter({data:c}))}var e=[!1,!1,!1,!1,!1],f=["答非所问","理解能力差","一问三不知","不礼貌"];b.stars=e.concat(),b.labels=f.concat(),b.end=!1,b.displayDescribe=!1,b.data={stars:0,value:0,describe:"",label:""},b.$watch("display",function(a,c){a!==c&&(b.displayDescribe=!1,b.data={stars:0,value:0,describe:"",label:""})}),b.confirm=function(a){void 0!=a?1==b.type?(b.data.stars=a,5!=b.data.stars?b.displayDescribe=!0:d(b.data)):(b.data.value=a,b.data.value===!1?b.displayDescribe=!0:d(b.data)):d(null)},b.commit=function(){d(b.data)},b.cancle=function(){b.display=!1,b.dcancle()}}}}]);var kefu=angular.module("RongCloudkefu",["RongWebIMWidget"]);kefu.service("RongKefu",["WebIMWidget",function(a){var b={},c={};return b.init=function(d){angular.extend(c,d),b._config=d;var e={right:20};d.position&&(e=d.position==KefuPostion.left?{left:20,width:325,positionFixed:!0}:{right:20,width:325,positionFixed:!0}),c.style=e,a.init(c),a.onShow=function(){a.setConversation(WidgetModule.EnumConversationType.CUSTOMER_SERVICE,d.kefuId,"客服")}},b.show=function(){a.show()},b.hidden=function(){a.hidden()},b.KefuPostion=KefuPostion,b}]);var KefuPostion;!function(a){a[a.left=1]="left",a[a.right=2]="right"}(KefuPostion||(KefuPostion={}));var widget=angular.module("RongWebIMWidget",["RongWebIMWidget.conversationServer","RongWebIMWidget.conversationListServer","RongIMSDKModule","Evaluate"]);widget.run(["$http","WebIMWidget","widgetConfig",function(a,b,c){var d="https:"===location.protocol?"https:":"http:";$script.get(d+"//cdn.ronghub.com/RongIMLib-2.1.0.min.js",function(){$script.get(d+"//cdn.ronghub.com/RongEmoji-2.0.15.min.js",function(){RongIMLib.RongIMEmoji&&RongIMLib.RongIMEmoji.init()}),$script.get(d+"//cdn.ronghub.com/RongIMVoice-2.0.15.min.js",function(){RongIMLib.RongIMVoice&&RongIMLib.RongIMVoice.init()}),c.config&&b.init(c.config)}),$script.get(d+"//cdn.bootcss.com/plupload/2.1.8/plupload.full.min.js",function(){})}]),widget.factory("providerdata",[function(){var a={_cacheUserInfo:[],getCacheUserInfo:function(b){for(var c=0,d=a._cacheUserInfo.length;d>c;c++)if(a._cacheUserInfo[c].userId==b)return a._cacheUserInfo[c];return null},addUserInfo:function(b){var c=a.getCacheUserInfo(b.userId);c?angular.extend(c,b):a._cacheUserInfo.push(b)}};return a}]),widget.factory("widgetConfig",[function(){return{}}]),widget.factory("WebIMWidget",["$q","conversationServer","conversationListServer","providerdata","widgetConfig","RongIMSDKServer",function(a,b,c,d,e,f){function g(a){var c=b._cacheHistory[a.conversationType+"_"+a.targetId]=b._cacheHistory[a.conversationType+"_"+a.targetId]||[];0==c.length&&(a.conversationType!=WidgetModule.EnumConversationType.CUSTOMER_SERVICE&&c.push(new WidgetModule.GetHistoryPanel),c.push(new WidgetModule.TimePanl(a.sentTime))),b._addHistoryMessages(a)}var h={},i=195,j=50,k=195,l={displayMinButton:!0,conversationListPosition:WidgetModule.EnumConversationListPosition.left,desktopNotification:!0,voiceNotification:!0,style:{positionFixed:!1,width:450,height:470,bottom:0,right:0}},m=null;return h.display=!1,h.init=function(a){if(!window.RongIMLib||!window.RongIMLib.RongIMClient)return void(e.config=a);l.desktopNotification&&WidgetModule.NotificationHelper.requestPermission();var n=l.style;angular.extend(l,a),angular.extend(n,a.style),m=document.getElementById("rongcloud-playsound"),m&&"string"==typeof l.voiceUrl?m.src=l.voiceUrl:l.voiceNotification=!1;var o=document.getElementById("rong-conversation"),p=document.getElementById("rong-conversation-list"),q=document.getElementById("rong-widget-minbtn");if(n)if(o.style.height=n.height+"px",o.style.width=n.width+"px",p.style.height=n.height+"px",n.positionFixed?(p.style.position="fixed",q.style.position="fixed",o.style.position="fixed"):(p.style.position="absolute",q.style.position="absolute",o.style.position="absolute"),l.displayConversationList){if(q.style.display="inline-block",p.style.display="inline-block",l.conversationListPosition==WidgetModule.EnumConversationListPosition.left)isNaN(n.left)||(p.style.left=n.left+"px",q.style.left=n.left+"px",o.style.left=n.left+i+"px"),isNaN(n.right)||(p.style.right=n.right+n.width+"px",q.style.right=n.right+n.width+"px",o.style.right=n.right+"px");else{if(l.conversationListPosition!=WidgetModule.EnumConversationListPosition.right)throw new Error("config conversationListPosition value is invalid");isNaN(n.left)||(p.style.left=n.left+n.width+"px",q.style.left=n.left+n.width+"px",o.style.left=n.left+"px"),isNaN(n.right)||(p.style.right=n.right+"px",q.style.right=n.right+"px",o.style.right=n.right+i+"px")}isNaN(n.top)||(p.style.top=n.top+"px",q.style.top=n.top+n.height-j+"px",o.style.top=n.top+"px"),isNaN(n.bottom)||(p.style.bottom=n.bottom+"px",q.style.bottom=n.bottom+"px",o.style.bottom=n.bottom+"px")}else q.style.display="inline-block",p.style.display="none",o.style.left=n.left+"px",o.style.right=n.right+"px",o.style.top=n.top+"px",o.style.bottom=n.bottom+"px",q.style.top=n.top+n.height-j+"px",q.style.bottom=n.bottom+"px",q.style.left=n.left+n.width/2-k/2+"px",q.style.right=n.right+n.width/2-k/2+"px";0==l.displayMinButton&&(q.style.display="none"),e.displayConversationList=l.displayConversationList,e.displayMinButton=l.displayMinButton,e.reminder=l.reminder,e.voiceNotification=l.voiceNotification,f.init(l.appkey),f.connect(l.token).then(function(a){c.updateConversations(),console.log("connect success:"+a),"function"==WidgetModule.Helper.checkType(l.onSuccess)&&l.onSuccess(a),"function"==WidgetModule.Helper.checkType(d.getUserInfo)&&d.getUserInfo(a,{onSuccess:function(a){b.loginUser.id=a.userId,b.loginUser.name=a.name,b.loginUser.portraitUri=a.portraitUri}}),b._onConnectSuccess()},function(a){a.tokenError?l.onError&&"function"==typeof l.onError&&l.onError({code:0,info:"token 无效"}):l.onError&&"function"==typeof l.onError&&l.onError({code:a.errorCode})}),f.setConnectionStatusListener({onChanged:function(a){switch(h.connected=!1,a){case RongIMLib.ConnectionStatus.CONNECTED:console.log("链接成功"),h.connected=!0;break;case RongIMLib.ConnectionStatus.CONNECTING:console.log("正在链接");break;case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:console.log("其他设备登录");break;case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:console.log("网络不可用")}h.onConnectStatusChange&&h.onConnectStatusChange(a),c._onConnectStatusChange&&c._onConnectStatusChange(a)}}),f.setOnReceiveMessageListener({onReceived:function(a){console.log(a);var e=WidgetModule.Message.convert(a);switch("function"==WidgetModule.Helper.checkType(d.getUserInfo)&&e.content&&d.getUserInfo(e.senderUserId,{onSuccess:function(a){a&&(e.content.userInfo=new WidgetModule.UserInfo(a.userId,a.name,a.portraitUri))}}),a.messageType){case WidgetModule.MessageType.VoiceMessage:e.content.isUnReade=!0;case WidgetModule.MessageType.TextMessage:case WidgetModule.MessageType.LocationMessage:case WidgetModule.MessageType.ImageMessage:case WidgetModule.MessageType.RichContentMessage:g(e);var i=1==d.voiceSound&&m&&a.messageDirection==WidgetModule.MessageDirection.RECEIVE&&l.voiceNotification,j=b.current&&b.current.targetType==e.conversationType&&b.current.targetId==e.targetId,k=(document.hidden||!h.display)&&a.messageDirection==WidgetModule.MessageDirection.RECEIVE&&l.desktopNotification;(l.displayConversationList&&i||!l.displayConversationList&&i&&j)&&m.play(),(k&&l.displayConversationList||!l.displayConversationList&&k&&j)&&WidgetModule.NotificationHelper.showNotification({title:e.content.userInfo.name,icon:"",body:WidgetModule.Message.messageToNotification(a),data:{targetId:e.targetId,targetType:e.conversationType}});break;case WidgetModule.MessageType.ContactNotificationMessage:break;case WidgetModule.MessageType.InformationNotificationMessage:g(e);break;case WidgetModule.MessageType.UnknownMessage:break;case WidgetModule.MessageType.ReadReceiptMessage:a.messageDirection==WidgetModule.MessageDirection.SEND&&f.clearUnreadCount(a.conversationType,a.targetId)}h.onReceivedMessage&&h.onReceivedMessage(e),b.onReceivedMessage(e),!document.hidden&&h.display&&b.current&&b.current.targetType==e.conversationType&&b.current.targetId==e.targetId&&a.messageDirection==WidgetModule.MessageDirection.RECEIVE&&a.messageType!=WidgetModule.MessageType.ReadReceiptMessage&&(f.clearUnreadCount(b.current.targetType,b.current.targetId),f.sendReadReceiptMessage(b.current.targetId,b.current.targetType)),c.updateConversations().then(function(){})}}),window.onfocus=function(){b.current&&b.current.targetId&&h.display&&f.getConversation(b.current.targetType,b.current.targetId).then(function(a){a&&a.unreadMessageCount>0&&(f.clearUnreadCount(b.current.targetType,b.current.targetId),f.sendReadReceiptMessage(b.current.targetId,b.current.targetType),c.updateConversations().then(function(){}))})}},h.setConversation=function(a,c,d){b.onConversationChangged(new WidgetModule.Conversation(a,c,d))},h.setUserInfoProvider=function(a){d.getUserInfo=a},h.setGroupInfoProvider=function(a){d.getGroupInfo=a},h.setOnlineStatusProvider=function(a){d.getOnlineStatus=a},h.EnumConversationListPosition=WidgetModule.EnumConversationListPosition,h.EnumConversationType=WidgetModule.EnumConversationType,h.show=function(){h.display=!0,h.fullScreen=!1},h.hidden=function(){h.display=!1},h.getCurrentConversation=function(){return b.current},h}]),widget.directive("rongWidget",[function(){return{restrict:"E",templateUrl:"./src/ts/main.tpl.html",controller:"rongWidgetController"}}]),widget.controller("rongWidgetController",["$scope","$interval","WebIMWidget","widgetConfig","providerdata","conversationServer","RongIMSDKServer","conversationListServer",function(a,b,c,d,e,f,g,h){a.main=c,a.widgetConfig=d,a.data=e,c.show=function(){c.display=!0,c.fullScreen=!1,c.onShow&&c.onShow(),setTimeout(function(){a.$apply()})};var i=null;a.$watch("data.totalUnreadCount",function(c,d){c>0?(i&&b.cancel(i),i=b(function(){a.twinkle=!a.twinkle},1e3)):b.cancel(i)}),a.$watch("main.display",function(){f.current&&f.current.targetId&&c.display&&g.getConversation(f.current.targetType,f.current.targetId).then(function(a){a&&a.unreadMessageCount>0&&(g.clearUnreadCount(f.current.targetType,f.current.targetId),g.sendReadReceiptMessage(f.current.targetId,f.current.targetType),h.updateConversations().then(function(){}))})}),c.hidden=function(){c.display=!1,setTimeout(function(){a.$apply()})},a.showbtn=function(){c.display=!0,c.onShow&&c.onShow()}}]),widget.filter("trustHtml",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),widget.filter("historyTime",["$filter",function(a){return function(b){var c=new Date;return b.toDateString()===c.toDateString()?a("date")(b,"HH:mm"):b.toDateString()===new Date(c.setTime(c.getTime()-1)).toDateString()?"昨天"+a("date")(b,"HH:mm"):a("date")(b,"yyyy-MM-dd HH:mm")}}]),widget.directive("errSrc",function(){return{link:function(a,b,c){c.ngSrc||c.$set("src",c.errSrc),b.bind("error",function(){c.src!=c.errSrc&&c.$set("src",c.errSrc)})}}});var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},WidgetModule;!function(a){!function(a){a[a.left=0]="left",a[a.right=1]="right"}(a.EnumConversationListPosition||(a.EnumConversationListPosition={}));a.EnumConversationListPosition;!function(a){a[a.PRIVATE=1]="PRIVATE",a[a.DISCUSSION=2]="DISCUSSION",a[a.GROUP=3]="GROUP",a[a.CHATROOM=4]="CHATROOM",a[a.CUSTOMER_SERVICE=5]="CUSTOMER_SERVICE",a[a.SYSTEM=6]="SYSTEM",a[a.APP_PUBLIC_SERVICE=7]="APP_PUBLIC_SERVICE",a[a.PUBLIC_SERVICE=8]="PUBLIC_SERVICE"}(a.EnumConversationType||(a.EnumConversationType={}));a.EnumConversationType;!function(a){a[a.SEND=1]="SEND",a[a.RECEIVE=2]="RECEIVE"}(a.MessageDirection||(a.MessageDirection={}));a.MessageDirection;!function(a){a[a.READ=1]="READ",a[a.LISTENED=2]="LISTENED",a[a.DOWNLOADED=4]="DOWNLOADED"}(a.ReceivedStatus||(a.ReceivedStatus={}));a.ReceivedStatus;!function(a){a[a.SENDING=10]="SENDING",a[a.FAILED=20]="FAILED",a[a.SENT=30]="SENT",a[a.RECEIVED=40]="RECEIVED",a[a.READ=50]="READ",a[a.DESTROYED=60]="DESTROYED"}(a.SentStatus||(a.SentStatus={}));var b;a.SentStatus;!function(a){a[a.left=1]="left",a[a.right=2]="right",a[a.top=3]="top",a[a.bottom=4]="bottom"}(b||(b={})),function(a){a[a.person=0]="person",a[a.robot=1]="robot",a[a.robotSwitchPerson=2]="robotSwitchPerson",a[a.notService=4]="notService"}(a.InputPanelType||(a.InputPanelType={}));a.InputPanelType;a.MessageType={DiscussionNotificationMessage:"DiscussionNotificationMessage ",TextMessage:"TextMessage",ImageMessage:"ImageMessage",VoiceMessage:"VoiceMessage",RichContentMessage:"RichContentMessage",HandshakeMessage:"HandshakeMessage",UnknownMessage:"UnknownMessage",SuspendMessage:"SuspendMessage",LocationMessage:"LocationMessage",InformationNotificationMessage:"InformationNotificationMessage",ContactNotificationMessage:"ContactNotificationMessage",ProfileNotificationMessage:"ProfileNotificationMessage",CommandNotificationMessage:"CommandNotificationMessage",HandShakeResponseMessage:"HandShakeResponseMessage",ChangeModeResponseMessage:"ChangeModeResponseMessage",TerminateMessage:"TerminateMessage",CustomerStatusUpdateMessage:"CustomerStatusUpdateMessage",ReadReceiptMessage:"ReadReceiptMessage"},function(a){a[a.Message=1]="Message",a[a.InformationNotification=2]="InformationNotification",a[a.System=103]="System",a[a.Time=104]="Time",a[a.getHistory=105]="getHistory",a[a.getMore=106]="getMore",a[a.Other=0]="Other"}(a.PanelType||(a.PanelType={}));var c=a.PanelType,d=function(){function a(a){this.panelType=a}return a}();a.ChatPanel=d;var e=function(a){function b(b){a.call(this,c.Time),this.sentTime=b}return __extends(b,a),b}(d);a.TimePanl=e;var f=function(a){function b(){a.call(this,c.getHistory)}return __extends(b,a),b}(d);a.GetHistoryPanel=f;var g=function(a){function b(){a.call(this,c.getMore)}return __extends(b,a),b}(d);a.GetMoreMessagePanel=g;var h=function(a){function b(b){a.call(this,c.Time),this.sentTime=b}return __extends(b,a),b}(d);a.TimePanel=h;var i=function(b){function d(a,d,e,f,g,h,i,j,k,l,m,n,o){b.call(this,c.Message)}return __extends(d,b),d.convert=function(b){var c=new d;switch(c.conversationType=b.conversationType,c.extra=b.extra,c.objectName=b.objectName,c.messageDirection=b.messageDirection,c.messageId=b.messageId,c.receivedStatus=b.receivedStatus,c.receivedTime=new Date(b.receivedTime),c.senderUserId=b.senderUserId,c.sentStatus=b.sendStatusMessage,c.sentTime=new Date(b.sentTime),c.targetId=b.targetId,c.messageType=b.messageType,c.messageType){case a.MessageType.TextMessage:var e=new l,f=b.content.content;RongIMLib.RongIMEmoji&&RongIMLib.RongIMEmoji.emojiToHTML&&(f=RongIMLib.RongIMEmoji.emojiToHTML(f)),e.content=f,c.content=e;break;case a.MessageType.ImageMessage:var g=new r,f=b.content.content||"";-1==f.indexOf("base64,")&&(f="data:image/png;base64,"+f),g.content=f,g.imageUri=b.content.imageUri,c.content=g;break;case a.MessageType.VoiceMessage:var h=new s;h.content=b.content.content,h.duration=b.content.duration,c.content=h;break;case a.MessageType.RichContentMessage:var i=new u;i.content=b.content.content,i.title=b.content.title,i.imageUri=b.content.imageUri,c.content=i;break;case a.MessageType.LocationMessage:var j=new t,f=b.content.content||"";-1==f.indexOf("base64,")&&(f="data:image/png;base64,"+f),j.content=f,j.latiude=b.content.latiude,j.longitude=b.content.longitude,j.poi=b.content.poi,c.content=j;break;case a.MessageType.InformationNotificationMessage:var k=new q;c.panelType=2,k.content=b.content.message,c.content=k;break;case a.MessageType.DiscussionNotificationMessage:var w=new v;w.extension=b.content.extension,w.operation=b.content.operation,w.type=b.content.type,w.isHasReceived=b.content.isHasReceived,c.content=w;case a.MessageType.HandShakeResponseMessage:var x=new m;x.status=b.content.status,x.msg=b.content.msg,x.data=b.content.data,c.content=x;break;case a.MessageType.ChangeModeResponseMessage:var y=new n;y.code=b.content.code,y.data=b.content.data,y.status=b.content.status,c.content=y;break;case a.MessageType.CustomerStatusUpdateMessage:var z=new p;z.serviceStatus=b.content.serviceStatus,c.content=z;break;case a.MessageType.TerminateMessage:var A=new o;A.code=b.content.code,c.content=A;break;default:console.log("未处理消息类型:"+b.messageType)}return c.content&&(c.content.userInfo=b.content.user),c},d.messageToNotification=function(b){if(!b)return null;var c,d=b.messageType;if(d==a.MessageType.ImageMessage)c="[图片]";else if(d==a.MessageType.LocationMessage)c="[位置]";else if(d==a.MessageType.VoiceMessage)c="[语音]";else if(d==a.MessageType.ContactNotificationMessage||d==a.MessageType.CommandNotificationMessage)c="[通知消息]";else if("RC:GrpNtf"==b.objectName){var e=b.content.message.content.data.data;switch(b.content.message.content.operation){case"Add":c=e.targetUserDisplayNames?e.targetUserDisplayNames.join("、")+" 加入了群组":"加入群组";break;case"Quit":c=e.operatorNickname+" 退出了群组";break;case"Kicked":c=e.targetUserDisplayNames?e.targetUserDisplayNames.join("、")+" 被剔出群组":"移除群组";break;case"Rename":c=e.operatorNickname+" 修改了群名称";break;case"Create":c=e.operatorNickname+" 创建了群组";break;case"Dismiss":c=e.operatorNickname+" 解散了群组 "+e.targetGroupName}}else c=b.content?b.content.content:"",c=RongIMLib.RongIMEmoji.emojiToSymbol(c),c=c.replace(/\n/g," "),c=c.replace(/([\w]{49,50})/g,"$1 ");return c},d}(d);a.Message=i;var j=function(){function a(a,b,c){this.userId=a,this.name=b,this.portraitUri=c}return a}();a.UserInfo=j;var k=function(){function a(a,b,c){this.userId=a,this.name=b,this.portraitUri=c}return a}();a.GroupInfo=k;var l=function(){function a(a){a=a||{},this.content=a.content,this.userInfo=a.userInfo}return a}();a.TextMessage=l;var m=function(){function a(){}return a}();a.HandShakeResponseMessage=m;var n=function(){function a(){}return a}();a.ChangeModeResponseMessage=n;var o=function(){function a(){}return a}();a.TerminateMessage=o;var p=function(){function a(){}return a}();a.CustomerStatusUpdateMessage=p;var q=function(){function a(){}return a}();a.InformationNotificationMessage=q;var r=function(){function a(){}return a}();a.ImageMessage=r;var s=function(){function a(){}return a}();a.VoiceMessage=s;var t=function(){function a(){}return a}();a.LocationMessage=t;var u=function(){function a(){}return a}();a.RichContentMessage=u;var v=function(){function a(){}return a}();a.DiscussionNotificationMessage=v;var w=function(){function a(a,b,c){this.targetType=a,this.targetId=b,this.title=c||""}return a.onvert=function(b){var c=new a;return c.targetId=b.targetId,c.targetType=b.conversationType,c.title=b.conversationTitle,c.portraitUri=b.senderPortraitUri,c.unreadMessageCount=b.unreadMessageCount,c},a}();a.Conversation=w;var x=window.navigator.userAgent,y=function(){function b(){}return b.timeCompare=function(a,b){var c=a.toString(),d=b.toString();return c.substring(0,c.lastIndexOf(":"))==d.substring(0,d.lastIndexOf(":"))},b.checkType=function(a){var b=Object.prototype.toString.call(a);return b.substring(8,b.length-1).toLowerCase()},b.browser={version:(x.match(/.+(?:rv|it|ra|chrome|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/.test(x),opera:/opera|opr/.test(x),msie:/msie|trident/.test(x)&&!/opera/.test(x),chrome:/chrome/.test(x),mozilla:/mozilla/.test(x)&&!/(compatible|webkit|like gecko)/.test(x)},b.getFocus=function(b){if(b.focus(),b.createTextRange){var c=b.createTextRange();c.moveStart("character",b.value.length),c.collapse(!0),c.select()}else if(b.selectionStart)b.selectionStart=b.value.length;else if(window.getSelection&&b.lastChild){var d=window.getSelection(),e=document.createRange();a.Helper.browser.msie?e.setStart(b.lastChild,b.lastChild.length):e.setStart(b.firstChild,b.firstChild.length),d.removeAllRanges(),d.addRange(e)}},b.ImageHelper={getThumbnail:function(b,c,d){var e=document.createElement("canvas"),f=e.getContext("2d"),g=new Image;g.onload=function(){var a,h,i=g.width*g.height;if(i>c){var j=Math.sqrt(i/c);j=Math.ceil(100*j)/100,a=g.width/j,h=g.height/j}else a=g.width,h=g.height;e.width=a,e.height=h,f.drawImage(g,0,0,a,h);try{var k=e.toDataURL("image/jpeg",.5);k=k.substr(23),d(b,k)}catch(l){d(b,null)}},g.src=a.Helper.ImageHelper.getFullPath(b)},getFullPath:function(a){return window.URL=window.URL||window.webkitURL,window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null}},b.CookieHelper={setCookie:function(a,b,c){if(c){var d=new Date;d.setDate(d.getDate()+c),document.cookie=a+"="+encodeURI(b)+";expires="+d.toUTCString()}else document.cookie=a+"="+encodeURI(b)+";"},getCookie:function(a){var b=document.cookie.indexOf(a+"=");if(-1!=b){var c=document.cookie.indexOf(";",b);return-1==c&&(c=document.cookie.length),decodeURI(document.cookie.substring(b+a.length+1,c))}return""},removeCookie:function(a){var b=this.getCookie(a);b&&this.setCookie(a,"con",-1)}},b}();a.Helper=y;var z=function(){function a(){}return a.isNotificationSupported=function(){return"function"==typeof Notification},a.requestPermission=function(){a.isNotificationSupported()&&Notification.requestPermission(function(a){})},a.onclick=function(a){},a.showNotification=function(b){if(!a.isNotificationSupported())return void console.log("the current browser does not support Notification API");if("granted"!==Notification.permission)return void console.log("the current page has not been granted for notification");if(a.desktopNotification){var c=b.title;delete b.title;var d=new Notification(c,b);d.onshow=function(){setTimeout(function(){d.close()},5e3)},d.onclick=function(){window.focus(),a.onclick(d),d.close()},d.onerror=function(){},d.onclose=function(){}}},a.desktopNotification=!0,a}();a.NotificationHelper=z}(WidgetModule||(WidgetModule={}));var SDKServer=angular.module("RongIMSDKModule",[]);SDKServer.factory("RongIMSDKServer",["$q",function(a){var b={};return b.init=function(a){RongIMLib.RongIMClient.init(a)},b.connect=function(b){var c=a.defer();return RongIMLib.RongIMClient.connect(b,{onSuccess:function(a){c.resolve(a)},onTokenIncorrect:function(){c.reject({tokenError:!0})},onError:function(a){c.reject({errorCode:a});var b="";switch(a){case RongIMLib.ErrorCode.TIMEOUT:b="连接超时";break;case RongIMLib.ErrorCode.UNKNOWN:b="未知错误";break;case RongIMLib.ConnectionState.UNACCEPTABLE_PROTOCOL_VERSION:b="不可接受的协议版本";break;case RongIMLib.ConnectionState.IDENTIFIER_REJECTED:b="appkey不正确";break;case RongIMLib.ConnectionState.SERVER_UNAVAILABLE:b="服务器不可用";break;case RongIMLib.ConnectionState.NOT_AUTHORIZED:b="未认证";break;case RongIMLib.ConnectionState.REDIRECT:b="重新获取导航";break;case RongIMLib.ConnectionState.APP_BLOCK_OR_DELETE:b="应用已被封禁或已被删除";break;case RongIMLib.ConnectionState.BLOCK:b="用户被封禁"}console.log("失败:"+b)}}),c.promise},b.getInstance=function(){return RongIMLib.RongIMClient.getInstance()},b.sendReadReceiptMessage=function(a,c){RongIMLib.RongIMClient.getInstance().getConversation(Number(c),a,{onSuccess:function(d){if(d){var e=RongIMLib.ReadReceiptMessage.obtain(d.latestMessage.messageUId,d.latestMessage.sentTime,"1");b.sendMessage(c,a,e)}},onError:function(){}})},b.setOnReceiveMessageListener=function(a){RongIMLib.RongIMClient.setOnReceiveMessageListener(a)},b.setConnectionStatusListener=function(a){RongIMLib.RongIMClient.setConnectionStatusListener(a)},b.sendMessage=function(b,c,d){var e=a.defer();return RongIMLib.RongIMClient.getInstance().sendMessage(+b,c,d,{onSuccess:function(a){e.resolve(a)},onError:function(a,b){e.reject({errorCode:a,message:b});var c="";switch(a){case RongIMLib.ErrorCode.TIMEOUT:c="超时";break;case RongIMLib.ErrorCode.UNKNOWN:c="未知错误";break;case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:c="在黑名单中，无法向对方发送消息";break;case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:c="不在讨论组中";break;case RongIMLib.ErrorCode.NOT_IN_GROUP:c="不在群组中";break;case RongIMLib.ErrorCode.NOT_IN_CHATROOM:c="不在聊天室中";break;default:c=""}console.log("发送失败:"+c)}}),e.promise},b.reconnect=function(a){RongIMLib.RongIMClient.reconnect(a)},b.clearUnreadCount=function(b,c){var d=a.defer();return RongIMLib.RongIMClient.getInstance().clearUnreadCount(b,c,{onSuccess:function(a){d.resolve(a)},onError:function(a){d.reject(a)}}),d.promise},b.getTotalUnreadCount=function(){var b=a.defer();return RongIMLib.RongIMClient.getInstance().getTotalUnreadCount({onSuccess:function(a){
b.resolve(a)},onError:function(){b.reject()}}),b.promise},b.getConversationList=function(){var b=a.defer();return RongIMLib.RongIMClient.getInstance().getConversationList({onSuccess:function(a){b.resolve(a)},onError:function(a){b.reject(a)}},null),b.promise},b.removeConversation=function(b,c){var d=a.defer();return RongIMLib.RongIMClient.getInstance().removeConversation(b,c,{onSuccess:function(a){d.resolve(a)},onError:function(a){d.reject(a)}}),d.promise},b.createConversation=function(a,b,c){RongIMLib.RongIMClient.getInstance().createConversation(a,b,c)},b.getConversation=function(b,c){var d=a.defer();return RongIMLib.RongIMClient.getInstance().getConversation(Number(b),c,{onSuccess:function(a){d.resolve(a)},onError:function(){d.reject()}}),d.promise},b.getDraft=function(a,b){return RongIMLib.RongIMClient.getInstance().getTextMessageDraft(a,b)||""},b.setDraft=function(a,b,c){return RongIMLib.RongIMClient.getInstance().saveTextMessageDraft(a,b,c)},b.clearDraft=function(a,b){return RongIMLib.RongIMClient.getInstance().clearTextMessageDraft(a,b)},b.getHistoryMessages=function(b,c,d){var e=a.defer();return RongIMLib.RongIMClient.getInstance().getHistoryMessages(b,c,null,d,{onSuccess:function(a,b){e.resolve({data:a,has:b})},onError:function(a){e.reject(a)}}),e.promise},b.disconnect=function(){RongIMLib.RongIMClient.getInstance().disconnect()},b.logout=function(){RongIMLib&&RongIMLib.RongIMClient&&RongIMLib.RongIMClient.getInstance().logout()},b.voice={init:function(){},play:function(a,b){RongIMLib.voice.play(a,b)}},b}]),angular.module("RongWebIMWidget").run(["$templateCache",function(a){"use strict";a.put("./src/ts/conversation/template.tpl.html",'<div id=rong-conversation class="rongcloud-kefuChatBox rongcloud-both rongcloud-am-fade-and-slide-top" ng-show=showSelf ng-class="{\'fullScreen\':resoures.fullScreen}"><evaluatedir type=evaluate.type display=evaluate.showevaluate confirm=evaluate.onConfirm(data) cancle=evaluate.onCancle()></evaluatedir><div class=rongcloud-kefuChat><div id=header class="rongcloud-rong-header rongcloud-blueBg rongcloud-online"><div class="rongcloud-infoBar rongcloud-pull-left"><div class=rongcloud-infoBarTit><span class=rongcloud-kefuName ng-bind=currentConversation.title></span></div></div><div class="rongcloud-toolBar rongcloud-headBtn rongcloud-pull-right"><div ng-show=!widgetConfig.displayConversationList&&widgetConfig.voiceNotification class=rongcloud-voice ng-class="{\'rongcloud-voice-mute\':!data.voiceSound,\'rongcloud-voice-sound\':data.voiceSound}" ng-click="data.voiceSound=!data.voiceSound"></div><a href=javascript:; class="rongcloud-kefuChatBoxHide rongcloud-sprite" ng-show=!widgetConfig.displayConversationList ng-click=minimize() title=隐藏></a> <a href=javascript:; class="rongcloud-kefuChatBoxClose rongcloud-sprite" ng-click=close() title=结束对话></a></div></div><div class="rongcloud-outlineBox rongcloud-hide"><div class=rongcloud-sprite></div><span>网络连接断开</span></div><div id=Messages><div class=rongcloud-emptyBox>暂时没有新消息</div><div class=rongcloud-MessagesInner><div ng-repeat="item in messageList" ng-switch=item.panelType><div class=rongcloud-Messages-date ng-switch-when=104><b>{{item.sentTime|historyTime}}</b></div><div class=rongcloud-Messages-history ng-switch-when=105><b ng-click=getHistory()>查看历史消息</b></div><div class=rongcloud-Messages-history ng-switch-when=106><b ng-click=getMoreMessage()>获取更多消息</b></div><div class=rongcloud-sys-tips ng-switch-when=2><span ng-bind-html=item.content.content|trustHtml></span></div><div class=rongcloud-Message ng-switch-when=1><div class=rongcloud-Messages-unreadLine></div><div><div class=rongcloud-Message-header><img class="rongcloud-img rongcloud-u-isActionable rongcloud-Message-avatar rongcloud-avatar" ng-src="{{item.content.userInfo.portraitUri||\'http://7xo1cb.com1.z0.glb.clouddn.com/20160230163460.jpg\'}}" alt=""><div class="rongcloud-Message-author rongcloud-clearfix"><a class="rongcloud-author rongcloud-u-isActionable">{{item.content.userInfo.name}}</a> <span>{{item.content.userInfo.id}}</span></div></div></div><div class=rongcloud-Message-body ng-switch=item.messageType><textmessage ng-switch-when=TextMessage msg=item.content></textmessage><imagemessage ng-switch-when=ImageMessage msg=item.content></imagemessage><voicemessage ng-switch-when=VoiceMessage msg=item.content></voicemessage><locationmessage ng-switch-when=LocationMessage msg=item.content></locationmessage><richcontentmessage ng-switch-when=RichContentMessage msg=item.content></richcontentmessage></div></div></div></div></div><div id=footer class=rongcloud-rong-footer style="display: block"><div class=rongcloud-footer-con><div class=rongcloud-text-layout><div id=funcPanel class="rongcloud-funcPanel rongcloud-robotMode"><div class=rongcloud-mode1 ng-show="_inputPanelState==0"><div class=rongcloud-MessageForm-tool id=expressionWrap><i class="rongcloud-sprite rongcloud-iconfont-smile" ng-click="showemoji=!showemoji"></i><div class=rongcloud-expressionWrap ng-show=showemoji><i class=rongcloud-arrow></i><emoji ng-repeat="item in emojiList" item=item content=msgvalue></emoji></div></div><div class=rongcloud-MessageForm-tool><i class="rongcloud-sprite rongcloud-iconfont-upload" id=upload-file style="position: relative; z-index: 1"></i></div></div><div class=rongcloud-mode2 ng-show="_inputPanelState==2"><a ng-click=switchPerson() id=chatSwitch class=rongcloud-chatSwitch>转人工服务</a></div></div><pre id=inputMsg class="rongcloud-text rongcloud-grey" contenteditable contenteditable-dire ng-focus="showemoji=fase" style="background-color: rgba(0,0,0,0);color:black" ctrl-enter-keys fun=send() ctrlenter=false placeholder=请输入文字... ondrop="return false" ng-model=currentConversation.messageContent></pre></div><div class=rongcloud-powBox><button type=button style="background-color: #0099ff" class="rongcloud-rong-btn rongcloud-rong-send-btn" id=rong-sendBtn ng-click=send()>发送</button></div></div></div></div></div>'),a.put("./src/ts/conversationlist/conversationList.tpl.html",'<div id=rong-conversation-list class="rongcloud-kefuListBox rongcloud-both"><div class=rongcloud-kefuList><div class="rongcloud-rong-header rongcloud-blueBg"><div class="rongcloud-toolBar rongcloud-headBtn"><div ng-show=config.voiceNotification class=rongcloud-voice ng-class="{\'rongcloud-voice-mute\':!data.voiceSound,\'rongcloud-voice-sound\':data.voiceSound}" ng-click="data.voiceSound=!data.voiceSound"></div><div class="rongcloud-sprite rongcloud-people"></div><span class=rongcloud-recent>最近联系人</span><div class="rongcloud-sprite rongcloud-arrow-down" style="cursor: pointer" ng-click=minbtn()></div></div></div><div class=rongcloud-content><div class=rongcloud-netStatus ng-hide=connected><div class=rongcloud-sprite></div><span>连接断开,请刷新重连</span></div><div><conversation-item ng-repeat="item in conversationListServer.conversationList" item=item></conversation-item></div></div></div></div>'),a.put("./src/ts/evaluate/evaluate.tpl.html",'<div class=rongcloud-layermbox ng-show=display><div class=rongcloud-laymshade></div><div class=rongcloud-layermmain><div class=rongcloud-section><div class=rongcloud-layermchild ng-show=!end><div class=rongcloud-layermcont><div class=rongcloud-type1 ng-show="type==1"><h4>&nbsp;评价客服</h4><div class=rongcloud-layerPanel1><div class=rongcloud-star><span ng-repeat="item in stars track by $index"><span ng-class="{\'rongcloud-star-on\':$index<data.stars,\'rongcloud-star-off\':$index>=data.stars}" ng-click=confirm($index+1)></span></span></div></div></div><div class=rongcloud-type2 ng-show="type==2"><h4>&nbsp;&nbsp;是否解决了您的问题 ？</h4><div class=rongcloud-layerPanel1><a class="rongcloud-rong-btn rongcloud-btnY" ng-class="{\'cur\':data.value===true}" href=javascript:void(0); ng-click=confirm(true)>是</a> <a class="rongcloud-rong-btn rongcloud-btnN" ng-class="{\'cur\':data.value===false}" href=javascript:void(0); ng-click=confirm(false)>否</a></div></div><div class=rongcloud-layerPanel2 ng-show=displayDescribe><p>是否有以下情况 ？</p><div class=rongcloud-labels><span ng-repeat="item in labels"><a class=rongcloud-rong-btn ng-class="{\'cur\':data.label==item}" ng-click="data.label=item" href="">{{item}}</a></span></div><div class=rongcloud-suggestBox><textarea name="" placeholder=欢迎给我们的服务提建议~ ng-model=data.describe></textarea></div><div class=rongcloud-subBox><a class=rongcloud-rong-btn href="" ng-click=commit()>提交评价</a></div></div></div><div class=rongcloud-layermbtn><span ng-click=confirm()>跳过</span><span ng-click=cancle()>取消</span></div></div><div class="rongcloud-layermchild rongcloud-feedback" ng-show=end><div class=rongcloud-layermcont>感谢您的反馈 ^ - ^ ！</div></div></div></div></div>'),a.put("./src/ts/main.tpl.html",'<div id=rong-widget-box class=rongcloud-container><div ng-show=main.display><rong-conversation></rong-conversation><rong-conversation-list></rong-conversation-list></div><div id=rong-widget-minbtn class="rongcloud-kefuBtnBox rongcloud-blueBg" ng-show=!main.display&&widgetConfig.displayMinButton ng-click=showbtn()><a class=rongcloud-kefuBtn href="javascript: void(0);"><div class="rongcloud-sprite rongcloud-people"></div><span class=rongcloud-recent ng-show="!data.totalUnreadCount||data.totalUnreadCount==0">{{widgetConfig.reminder||"最近联系人"}}</span> <span class=rongcloud-recent ng-show="data.totalUnreadCount>0"><span ng-show=twinkle>(您有未读消息)</span></span></a></div><audio id=rongcloud-playsound style="width: 0px;height: 0px;display: none" src="" controls></audio></div>')}]),function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b():"function"==typeof define&&define.amd?define(b):this[a]=b()}("$script",function(){function a(a,b){for(var c=0,d=a.length;d>c;++c)if(!b(a[c]))return i;return 1}function b(b,c){a(b,function(a){return!c(a)})}function c(f,g,h){function i(a){return a.call?a():m[a]}function k(){if(!--s){m[r]=1,q&&q();for(var c in o)a(c.split("|"),i)&&!b(o[c],i)&&(o[c]=[])}}f=f[j]?f:[f];var l=g&&g.call,q=l?g:h,r=l?f.join(""):g,s=f.length;return setTimeout(function(){b(f,function a(b,c){return null===b?k():(!c&&!/^https?:\/\//.test(b)&&e&&(b=-1===b.indexOf(".js")?e+b+".js":e+b),p[b]?(r&&(n[r]=1),2==p[b]?k():setTimeout(function(){a(b,!0)},0)):(p[b]=1,r&&(n[r]=1),d(b,k),void 0))})},0),c}function d(a,b){var c,d=g.createElement("script");d.onload=d.onerror=d[l]=function(){d[k]&&!/^c|loade/.test(d[k])||c||(d.onload=d[l]=null,c=1,p[a]=2,b())},d.async=1,d.src=f?a+(-1===a.indexOf("?")?"?":"&")+f:a,h.insertBefore(d,h.lastChild)}var e,f,g=document,h=g.getElementsByTagName("head")[0],i=!1,j="push",k="readyState",l="onreadystatechange",m={},n={},o={},p={};return c.get=d,c.order=function(a,b,d){!function e(f){f=a.shift(),a.length?c(f,e):c(f,b,d)}()},c.path=function(a){e=a},c.urlArgs=function(a){f=a},c.ready=function(d,e,f){d=d[j]?d:[d];var g=[];return!b(d,function(a){m[a]||g[j](a)})&&a(d,function(a){return m[a]})?e():!function(a){o[a]=o[a]||[],o[a][j](e),f&&f(g)}(d.join("|")),c},c.done=function(a){c([null],a)},c});var Qiniu=new QiniuJsSDK;